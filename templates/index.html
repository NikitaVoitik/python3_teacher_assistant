<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helper</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='logos/logo.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
<div class="chat-container">
    <div class="chat-window" id="chat-window">
    </div>
    <div class="input-container">
        <button class="icon-button" onclick="resetHistory()">
            <img src="{{ url_for('static', filename='logos/reset.svg') }}" alt="Reset" class="icon">
        </button>
        <textarea id="user-input" placeholder="Type your message here..." oninput="autoGrow(this)"></textarea>
        <div class="dropdown">
            <button class="dropbtn">
                <img src="{{ url_for('static', filename='logos/methods.svg') }}" alt="Modes" class="icon"
                     id="mode-icon">
            </button>
            <div class="dropdown-content">
                <a href="#"
                   onclick="setMode('Socratic Approach', '{{ url_for('static', filename='logos/socrates.svg') }}')">Socratic
                    Approach</a>
                <a href="#" onclick="setMode('Error Finding', '{{ url_for('static', filename='logos/error.svg') }}')">Error
                    Finding</a>
                <a href="#" onclick="setMode('Homework Checker', '{{ url_for('static', filename='logos/book.svg') }}')">Homework
                    Checker</a>
            </div>
        </div>
        <button class="icon-button" onclick="sendMessage()">
            <img src="{{ url_for('static', filename='logos/send.svg') }}" alt="Send" class="icon">
        </button>
    </div>
</div>

<script>
    let currentMode = 'Socratic Approach';

    function setMode(mode, iconUrl) {
        currentMode = mode;
        document.getElementById('mode-icon').src = iconUrl;
    }

    document.getElementById('user-input').addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        const userInput = document.getElementById('user-input').value.trim();
        if (userInput === '') return;

        const chatWindow = document.getElementById('chat-window');
        const userMessageContainer = document.createElement('div');
        userMessageContainer.className = 'message-container user';
        const userMessage = document.createElement('div');
        userMessage.className = 'user-message';
        userMessage.textContent = userInput;
        userMessageContainer.appendChild(userMessage);
        chatWindow.appendChild(userMessageContainer);

        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = '<span></span><span></span><span></span>';
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        fetch('/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({message: userInput, prompt_type: currentMode})
        })
            .then(response => response.json())
            .then(data => {
                chatWindow.removeChild(typingIndicator);
                const llmMessageContainer = document.createElement('div');
                llmMessageContainer.className = 'message-container';
                const llmResponse = document.createElement('div');
                llmResponse.className = 'llm-response';
                llmResponse.innerHTML = formatResponse(data.response);
                llmMessageContainer.appendChild(llmResponse);
                chatWindow.appendChild(llmMessageContainer);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });

        document.getElementById('user-input').value = '';
        document.getElementById('user-input').style.height = 'auto'; // Reset height
    }

    function resetHistory() {
        let messages = document.querySelectorAll('.message-container');
        messages.forEach(message => {
            message.remove();
        });
        fetch('/reset', {
            method: 'POST'
        });
    }

    function autoGrow(element) {
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }

    function formatResponse(response) {
        // Replace **text** with <b>text</b>
        response = response.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        // Replace \n with <br>
        response = response.replace(/\n/g, '<br>');
        return response;
    }
</script>
</body>
</html>