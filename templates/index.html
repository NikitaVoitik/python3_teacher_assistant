<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helper</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='logos/logo.svg') }}">
</head>
<body>
<div class="chat-container">
    <div class="chat-window" id="chat-window">
    </div>

    <!-- Drag and drop area -->
    <div class="drop-area" id="drop-area">
        <p>Drag & drop files here or click to upload</p>
        <input type="file" id="fileInput" style="display: none;" onchange="handleFileSelect(event)">
        <div class="file-info" id="file-info"></div>
    </div>

    <div class="input-container">
        <button class="icon-button" onclick="resetHistory()">
            <img src="{{ url_for('static', filename='logos/reset.svg') }}" alt="Reset" class="icon">
        </button>
        <textarea id="user-input" placeholder="Type your message here..." oninput="autoGrow(this)"></textarea>
        <div class="dropdown">
            <button class="dropbtn">
                <img src="{{ url_for('static', filename='logos/methods.svg') }}" alt="Modes" class="icon"
                     id="mode-icon">
            </button>
            <div class="dropdown-content">
                <a href="#"
                   onclick="setMode('Socratic Approach', '{{ url_for('static', filename='logos/socrates.svg') }}')">Socratic
                    Approach</a>
                <a href="#" onclick="setMode('Error Finding', '{{ url_for('static', filename='logos/error.svg') }}')">Error
                    Finding</a>
                <a href="#" onclick="setMode('Homework Checker', '{{ url_for('static', filename='logos/book.svg') }}')">Homework
                    Checker</a>
            </div>
        </div>
        <button class="icon-button" onclick="sendMessage()">
            <img src="{{ url_for('static', filename='logos/send.svg') }}" alt="Send" class="icon">
        </button>
    </div>
</div>

<!-- Mode selection modal -->
<div id="mode-modal" class="modal">
    <div class="modal-content">
        <h2>Select Mode</h2>
        <button onclick="selectMode('Socratic Approach', '{{ url_for('static', filename='logos/socrates.svg') }}')">Socratic Approach</button>
        <button onclick="selectMode('Error Finding', '{{ url_for('static', filename='logos/error.svg') }}')">Error Finding</button>
        <button onclick="selectMode('Homework Checker', '{{ url_for('static', filename='logos/book.svg') }}')">Homework Checker</button>
    </div>
</div>

<script>
    let currentMode = '';

    function setMode(mode, iconUrl) {
        currentMode = mode;
        document.getElementById('mode-icon').src = iconUrl;
    }

    function selectMode(mode, iconUrl) {
        setMode(mode, iconUrl);
        document.getElementById('mode-modal').style.display = 'none';
    }

    document.getElementById('user-input').addEventListener('keydown', function (event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    });

    function sendMessage() {
        if (currentMode === '') {
            alert('Please select a mode first.');
            return;
        }

        const userInput = document.getElementById('user-input').value.trim();
        if (userInput === '') return;

        const chatWindow = document.getElementById('chat-window');
        const userMessageContainer = document.createElement('div');
        userMessageContainer.className = 'message-container user';
        const userMessage = document.createElement('div');
        userMessage.className = 'user-message';
        userMessage.textContent = userInput;
        userMessageContainer.appendChild(userMessage);
        chatWindow.appendChild(userMessageContainer);

        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = '<span></span><span></span><span></span>';
        chatWindow.appendChild(typingIndicator);
        chatWindow.scrollTop = chatWindow.scrollHeight;

        fetch('/ask', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({message: userInput, prompt_type: currentMode})
        })
            .then(response => response.json())
            .then(data => {
                chatWindow.removeChild(typingIndicator);
                const llmMessageContainer = document.createElement('div');
                llmMessageContainer.className = 'message-container';
                const llmResponse = document.createElement('div');
                llmResponse.className = 'llm-response';
                llmResponse.innerHTML = formatResponse(data.response);
                llmMessageContainer.appendChild(llmResponse);
                chatWindow.appendChild(llmMessageContainer);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });

        document.getElementById('user-input').value = '';
        document.getElementById('user-input').style.height = 'auto'; // Reset height
    }

    function resetHistory() {
        let messages = document.querySelectorAll('.message-container');
        messages.forEach(message => {
            message.remove();
        });
        fetch('/reset', {
            method: 'POST'
        });
    }

    function autoGrow(element) {
        element.style.height = 'auto';
        element.style.height = (element.scrollHeight) + 'px';
    }

    function formatResponse(response) {
        // Replace **text** with <b>text</b>
        response = response.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>');
        // Replace \n with <br>
        response = response.replace(/\n/g, '<br>');
        return response;
    }

    // Drag and drop functionality
    const dropArea = document.getElementById('drop-area');
    let dragCounter = 0;

    window.addEventListener('dragenter', (event) => {
        event.preventDefault();
        dragCounter++;
        dropArea.style.display = 'flex';
    });

    window.addEventListener('dragleave', (event) => {
        event.preventDefault();
        dragCounter--;
        if (dragCounter === 0) {
            dropArea.style.display = 'none';
        }
    });

    window.addEventListener('dragover', (event) => {
        event.preventDefault();
    });

    window.addEventListener('drop', (event) => {
        event.preventDefault();
        dragCounter = 0;
        dropArea.style.display = 'none';
        // Handle file drop
        const files = event.dataTransfer.files;
        handleFiles(files);
    });

    function handleFiles(files) {
        const fileInfo = document.getElementById('file-info');
        fileInfo.innerHTML = '';
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const fileElement = document.createElement('div');
            fileElement.textContent = `File: ${file.name}`;
            fileInfo.appendChild(fileElement);
            uploadFile(file);
        }
    }

    function handleFileSelect(event) {
        const files = event.target.files;
        handleFiles(files);
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);

        const fileInfo = document.getElementById('file-info');
        const uploadStatus = document.createElement('div');
        uploadStatus.textContent = `Uploading ${file.name}...`;
        fileInfo.appendChild(uploadStatus);

        fetch('/file', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'ok') {
                    uploadStatus.textContent = `File ${file.name} uploaded successfully.`;
                    displayFileMessage(file.name);
                } else {
                    uploadStatus.textContent = `File ${file.name} upload failed.`;
                }
            })
            .catch(error => {
                uploadStatus.textContent = `Error uploading file ${file.name}: ${error}`;
            });
    }

    function displayFileMessage(fileName) {
        const chatWindow = document.getElementById('chat-window');
        const userMessageContainer = document.createElement('div');
        userMessageContainer.className = 'message-container user';
        const userMessage = document.createElement('div');
        userMessage.className = 'user-message file-message';
        const fileIcon = document.createElement('img');
        fileIcon.src = '{{ url_for('static', filename='logos/file.svg') }}';
        fileIcon.alt = 'File';
        fileIcon.className = 'file-icon';
        const fileNameElement = document.createElement('span');
        fileNameElement.textContent = fileName;
        userMessage.appendChild(fileIcon);
        userMessage.appendChild(fileNameElement);
        userMessageContainer.appendChild(userMessage);
        chatWindow.appendChild(userMessageContainer);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    // Show the mode selection modal on page load
    window.onload = function() {
        document.getElementById('mode-modal').style.display = 'flex';
    };
</script>
</body>
</html>